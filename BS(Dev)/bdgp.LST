C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 1   


C166 COMPILER V7.53.0.0, COMPILATION OF MODULE BDGP
OBJECT MODULE PLACED IN .\output\bdgp.obj
COMPILER INVOKED BY: C:\Keil\C166\BIN\C166.EXE bdgp.c XLARGE BROWSE MOD167 DEBUG TABS(2) OBJECT(.\output\bdgp.obj) 

 stmt lvl     source

    1         #include "bdgp.h"
    2         #include "bdsp.h"
    3         
    4         #include "can.h"
    5         #include "process.h"
    6         #include "protocol.h"
    7         #include "float.h"
    8         
    9         #include "settings.h"
   10         
   11         static float fLikelihoods[360];
   12         static float fAngleDiagramm[48];
   13         static uint8  msgCounterBDGP = 0;
   14         
   15         const float   fNormalBDSPFactor = 0.285714f;
   16         
   17         const uint8   startBDGPMsg[] = {0x40};
   18         const uint8   stopBDGPMsg[] = {0x41};
   19         const uint8   resetBDGPMsg[] = {0x42};
   20         //–¥–ª—è –≥—Ä–∞–Ω–∞—Ç—ã
   21         
   22         const float BDGPdirectionCoef[] = {
   23         1.0f,
   24         0.999996f,
   25         0.999982f,
   26         0.999961f,
   27         0.99993f,
   28         0.99989f,
   29         0.999842f,
   30         0.999785f,
   31         0.99972f,
   32         0.999646f,
   33         0.999563f,
   34         0.999471f,
   35         0.999371f,
   36         0.999262f,
   37         0.999145f,
   38         0.99902f,
   39         0.998886f,
   40         0.998743f,
   41         0.998592f,
   42         0.998433f,
   43         0.998266f,
   44         0.998091f,
   45         0.997907f,
   46         0.997716f,
   47         0.997516f,
   48         0.997309f,
   49         0.997094f,
   50         0.996871f,
   51         0.99664f,
   52         0.996402f,
   53         0.996156f,
   54         0.995903f,
   55         0.995643f,
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 2   

   56         0.995375f,
   57         0.9951f,
   58         0.994818f,
   59         0.99453f,
   60         0.994234f,
   61         0.993932f,
   62         0.993623f,
   63         0.993307f,
   64         0.992985f,
   65         0.992657f,
   66         0.992322f,
   67         0.991982f,
   68         0.991635f,
   69         0.991283f,
   70         0.990924f,
   71         0.990561f,
   72         0.990191f,
   73         0.989817f,
   74         0.989437f,
   75         0.989052f,
   76         0.988662f,
   77         0.988267f,
   78         0.987868f,
   79         0.987464f,
   80         0.987055f,
   81         0.986642f,
   82         0.986225f,
   83         0.985804f,
   84         0.985379f,
   85         0.98495f,
   86         0.984518f,
   87         0.984082f,
   88         0.983643f,
   89         0.983201f,
   90         0.982755f,
   91         0.982307f,
   92         0.981856f,
   93         0.981402f,
   94         0.980946f,
   95         0.980487f,
   96         0.980027f,
   97         0.979564f,
   98         0.9791f,
   99         0.978633f,
  100         0.978165f,
  101         0.977696f,
  102         0.977225f,
  103         0.976754f,
  104         0.976281f,
  105         0.975807f,
  106         0.975333f,
  107         0.974858f,
  108         0.974383f,
  109         0.973907f,
  110         0.973432f,
  111         0.972956f,
  112         0.972481f,
  113         0.972005f,
  114         0.971531f,
  115         0.971057f,
  116         0.970583f,
  117         0.970111f,
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 3   

  118         0.96964f,
  119         0.969169f,
  120         0.968701f,
  121         0.968233f,
  122         0.967767f,
  123         0.967303f,
  124         0.966841f,
  125         0.966381f,
  126         0.965923f,
  127         0.965467f,
  128         0.965013f,
  129         0.964563f,
  130         0.964114f,
  131         0.963669f,
  132         0.963227f,
  133         0.962787f,
  134         0.962351f,
  135         0.961918f,
  136         0.961488f,
  137         0.961062f,
  138         0.96064f,
  139         0.960222f,
  140         0.959807f,
  141         0.959396f,
  142         0.95899f,
  143         0.958588f,
  144         0.952701f,
  145         0.935417f,
  146         0.912921f,
  147         0.886712f,
  148         0.8575f,
  149         0.825714f,
  150         0.791644f,
  151         0.755501f,
  152         0.71745f,
  153         0.67762f,
  154         0.63612f,
  155         0.593042f,
  156         0.548465f,
  157         0.50246f,
  158         0.455088f,
  159         0.406407f,
  160         0.356468f,
  161         0.30532f,
  162         0.253008f,
  163         0.209271f,
  164         0.183096f,
  165         0.163388f,
  166         0.147567f,
  167         0.134443f,
  168         0.123329f,
  169         0.113776f,
  170         0.105474f,
  171         0.098197f,
  172         0.091773f,
  173         0.086069f,
  174         0.080979f,
  175         0.07642f,
  176         0.07232f,
  177         0.068624f,
  178         0.065283f,
  179         0.062256f,
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 4   

  180         0.059509f,
  181         0.057013f,
  182         0.054743f,
  183         0.052676f,
  184         0.050794f,
  185         0.049079f,
  186         0.047519f,
  187         0.046099f,
  188         0.04481f,
  189         0.04364f,
  190         0.042583f,
  191         0.041629f,
  192         0.040773f,
  193         0.040008f,
  194         0.03933f,
  195         0.038735f,
  196         0.038217f,
  197         0.037775f,
  198         0.037406f,
  199         0.037106f,
  200         0.036875f,
  201         0.036711f,
  202         0.036613f,
  203         0.036581f
  204         };
  205         //–¥–ª—è —Å–ø–µ–∫—Ç—Ä–æ–º–µ—Ç—Ä–∞
  206         const float BDSPdirectionCoef[] = {
  207         1.0000,
  208         1.0000,
  209         1.0000,
  210         0.99949,
  211         0.9961,
  212         0.9948,
  213         0.99357,
  214         0.99241,
  215         0.9913,
  216         0.99025,
  217         0.98925,
  218         0.98829,
  219         0.98736,
  220         0.98647,
  221         0.9856,
  222         0.98474,
  223         0.9839,
  224         0.98307,
  225         0.98224,
  226         0.98141,
  227         0.98057,
  228         0.97971,
  229         0.97884,
  230         0.97794,
  231         0.97701,
  232         0.97604,
  233         0.97504,
  234         0.97399,
  235         0.97289,
  236         0.97174,
  237         0.97053,
  238         0.96925,
  239         0.96791,
  240         0.96649,
  241         0.965,
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 5   

  242         0.96343,
  243         0.96177,
  244         0.96002,
  245         0.95817,
  246         0.95623,
  247         0.95419,
  248         0.95204,
  249         0.94978,
  250         0.9474,
  251         0.94491,
  252         0.9423,
  253         0.93956,
  254         0.93669,
  255         0.93369,
  256         0.93056,
  257         0.92728,
  258         0.92387,
  259         0.92031,
  260         0.9166,
  261         0.91274,
  262         0.90872,
  263         0.90455,
  264         0.90021,
  265         0.89571,
  266         0.89105,
  267         0.88621,
  268         0.88121,
  269         0.87603,
  270         0.87067,
  271         0.86514,
  272         0.85942,
  273         0.85352,
  274         0.84744,
  275         0.84116,
  276         0.8347,
  277         0.82804,
  278         0.82119,
  279         0.81414,
  280         0.8069,
  281         0.79945,
  282         0.79181,
  283         0.78396,
  284         0.7759,
  285         0.76764,
  286         0.75917,
  287         0.7505,
  288         0.74161,
  289         0.73251,
  290         0.7232,
  291         0.71368,
  292         0.70394,
  293         0.69398,
  294         0.68381,
  295         0.67342,
  296         0.66281,
  297         0.65198,
  298         0.64094,
  299         0.62967,
  300         0.61818,
  301         0.60647,
  302         0.59454,
  303         0.58239,
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 6   

  304         0.57002,
  305         0.55742,
  306         0.54461,
  307         0.53522,
  308         0.52851,
  309         0.51786,
  310         0.50698,
  311         0.49591,
  312         0.48469,
  313         0.47337,
  314         0.46199,
  315         0.45058,
  316         0.43919,
  317         0.42785,
  318         0.41658,
  319         0.40543,
  320         0.39442,
  321         0.38358,
  322         0.37293,
  323         0.36251,
  324         0.35233,
  325         0.3424,
  326         0.33276,
  327         0.32342,
  328         0.3144,
  329         0.3057,
  330         0.29734,
  331         0.28933,
  332         0.28168,
  333         0.27439,
  334         0.26748,
  335         0.26093,
  336         0.25476,
  337         0.24897,
  338         0.24354,
  339         0.23848,
  340         0.23378,
  341         0.22943,
  342         0.22543,
  343         0.22176,
  344         0.21841,
  345         0.21537,
  346         0.21261,
  347         0.21013,
  348         0.20789,
  349         0.20589,
  350         0.20409,
  351         0.20247,
  352         0.201,
  353         0.19965,
  354         0.1984,
  355         0.19721,
  356         0.19605,
  357         0.193825,
  358         0.19206,
  359         0.19145,
  360         0.19095,
  361         0.19054,
  362         0.19022,
  363         0.18997,
  364         0.1898,
  365         0.18968,
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 7   

  366         0.18962,
  367         0.1896,
  368         0.18963,
  369         0.18969,
  370         0.18977,
  371         0.18988,
  372         0.19,
  373         0.19013,
  374         0.19027,
  375         0.19041,
  376         0.19055,
  377         0.19068,
  378         0.19081,
  379         0.19092,
  380         0.19102,
  381         0.19111,
  382         0.19118,
  383         0.19122,
  384         0.19125,
  385         0.19126,
  386         0.19125,
  387         0.19122
  388         };
  389         
  390         static tBDGPData      BDGPData;
  391         static tBDGPParametrs BDGPParametrs[2];
  392         
  393         static float      doseArray[SLIDER_SIZE];
  394         
  395         static uint8      sliderCounter = 0;
  396         static uint8      dynamicMode = 0;
  397         static uint8      sliderMax = 0;
  398         static uint8      currentRangeIndex = 0;  //–Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
  399         
  400         uint16  BDGP_MinCounter()
  401         {
  402  1        uint8   i = 0;
  403  1        uint16  result = 0xFFFF;
  404  1        
  405  1          for(i = 0;i<SENSORS;i++){
  406  2            if(BDGPData.WorkData[i] < result)
  407  2              result = BDGPData.WorkData[i];
  408  2          }
  409  1        return result;
  410  1      }
  411         uint16  BDGP_MaxCounter()
  412         {
  413  1        uint8   i = 0;
  414  1        uint16  result = 0;
  415  1        
  416  1          for(i = 0;i<SENSORS;i++){
  417  2            if(BDGPData.WorkData[i] > result)
  418  2              result = BDGPData.WorkData[i];
  419  2          }
  420  1        return result;
  421  1      }
  422         
  423         float BDGP_MinSumSensData()
  424         {
  425  1        uint8 i = 0;
  426  1        float result = FLT_MAX;
  427  1          for(i = 0;i<SENSORS;i++){
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 8   

  428  2            if(BDGPData.fCorrectionSumSensData[i] < result)
  429  2              result = BDGPData.fCorrectionSumSensData[i];
  430  2          }
  431  1        return result;
  432  1      }
  433         float BDGP_MaxSumSensData()
  434         {
  435  1        uint8 i = 0;
  436  1        float result = FLT_MIN;
  437  1          for(i = 0;i<SENSORS;i++){
  438  2            if(BDGPData.fCorrectionSumSensData[i] > result)
  439  2              result = BDGPData.fCorrectionSumSensData[i];
  440  2          }
  441  1        return result;
  442  1      }
  443         
  444         void  BDGP_Reset()
  445         {
  446  1        msgCounterBDGP = 0;
  447  1        sliderCounter = 0;
  448  1        dynamicMode = 0;
  449  1        sliderMax = 0;
  450  1        
  451  1        memset(doseArray,0,sizeof(float) * SLIDER_SIZE);
  452  1        memset((uint8*)&BDGPData,0,sizeof(tBDGPData));
  453  1        memset((uint8*)&BDGPParametrs,0,sizeof(tBDGPParametrs) * 2);
  454  1        
  455  1        CAN_SendMessage(CAN_BDGP_CMD_TX,resetBDGPMsg,1);
  456  1        
  457  1        
  458  1      
  459  1      }
  460         
  461         
  462         /*
  463         –§–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ CAN —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∏–∑ –ë–î
  464           range - 1,2 / –¥–∏–∞–ø–∞–∑–æ–Ω—ã –±–ª–æ–∫–∞ –ë–î–ì–ü
  465           paramIndex - –ò–î –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  466           paramSubIndex - –°—É–±–∏–Ω–¥–µ–∫—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  467         */
  468         void  BDGP_ParametrRequest(uint8  range,uint8 paramIndex,uint8  paramSubIndex)
  469         {
  470  1        uint16  canID = 0x222 + range;
  471  1        
  472  1        uint8 Data[8];
  473  1          
  474  1          memset((uint8*)Data,0,sizeof(uint8) * 8);
  475  1          
  476  1          Data[0] = 0x05;
  477  1          Data[1] = paramIndex;
  478  1          Data[2] = 0x00;
  479  1          Data[3] = paramSubIndex;
  480  1        
  481  1        CAN_SendMessage(canID,Data,8);
  482  1      }
  483         /*
  484         –§-–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ CAN —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –∑–∞–ø–∏—Å—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ –ë–î
  485           range - 1,2 –¥–∏–∞–ø–∞–∑–æ–Ω—ã –±–ª–æ–∫ –ë–î–ì–ü
  486           paramIndex - –∏–Ω–¥–µ–∫—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  487           paramSubIndex - —Å—É–±–∏–Ω–¥–µ–∫—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  488           *pParam - —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –¥–∞–Ω–Ω—ã–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
  489           dataSize - —Ä–∞–º–µ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 9   

  490         */
  491         void BDGP_WriteParametr(uint8 range,uint8 paramIndex,uint8 paramSubIndex, uint8 *pParam,int dataSize)
  492         {
  493  1        uint16  canID = 0x222 + range;
  494  1        uint8 Data[8];
  495  1        
  496  1          memset((uint8*)Data,0,sizeof(uint8) * 8);
  497  1        
  498  1          Data[0] = 0x04;
  499  1          Data[1] = paramIndex;
  500  1          Data[2] = 0x00;
  501  1          Data[3] = paramSubIndex;
  502  1        
  503  1          memcpy(Data + 4,(uint32*)(pParam),dataSize);
  504  1        
  505  1        CAN_SendMessageIT(canID,Data,8);
  506  1          
  507  1      }
  508         //–∑–∞–ø—É—Å–∫ –∑–∞–ø–∏—Å–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –ë–î
  509         void  BDGP_StartWritingParametrs(uint8  rangeIndex)
  510         {
  511  1        BDGP_WriteParametr(1 + rangeIndex,0x93,0,(uint8*)&BDGPParametrs[rangeIndex].fCorrectionFactors[0],sizeof(
             -float));
  512  1      }
  513         
  514         void  BDGP_Start()
  515         {
  516  1        CAN_SendMessage(CAN_BDGP_CMD_TX,startBDGPMsg,1);
  517  1      }
  518         void  BDGP_ForcedStart(uint8  rangeNumber)
  519         {
  520  1        uint8 pData[2];
  521  1        
  522  1      
  523  1          pData[0] = 0x40;
  524  1          pData[1] = rangeNumber;
  525  1        
  526  1        CAN_SendMessage(CAN_BDGP_CMD_TX,pData,2);
  527  1      }
  528         
  529         void  BDGP_Stop()
  530         {
  531  1        CAN_SendMessage(CAN_BDGP_CMD_TX,stopBDGPMsg,1);
  532  1      }
  533         
  534         void  BDGP_InsertParametrs(uint16 regID,uint8 *pData)
  535         {
  536  1        uint32  rangesPack = 0;
  537  1        uint8   rangeIndex = 0;
  538  1      
  539  1          if(regID == 0x423) rangeIndex = 0;
  540  1          else if(regID == 0x424) rangeIndex = 1;
  541  1          else return;
  542  1        
  543  1        //–∑–∞–ø—Ä–æ—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  544  1        if(pData[0] == 0x05)
  545  1        {
  546  2          switch(pData[1])
  547  2          {
  548  3            case 0x93:
  549  3            {
  550  4              memcpy((uint8*)&BDGPParametrs[rangeIndex].fCorrectionFactors[pData[3]],(pData + 4),4);
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 10  

  551  4              
  552  4                if(pData[3]<12){
  553  5                  BDGP_ParametrRequest(rangeIndex + 1,0x93,pData[3]+1);
  554  5                }
  555  4                else
  556  4                  BDGP_ParametrRequest(rangeIndex + 1,0x94,0);
  557  4                
  558  4              
  559  4            }break;
  560  3            
  561  3            case 0x94:
  562  3            {
  563  4                memcpy((uint8*)&BDGPParametrs[rangeIndex].fDeadTime,(pData + 4),4);
  564  4                  BDGP_ParametrRequest(rangeIndex + 1,0x95,0);
  565  4            }break;
  566  3            
  567  3            case 0x95:
  568  3            {
  569  4              memcpy((uint8*)&BDGPParametrs[rangeIndex].fEffectCounters,(pData + 4),4);
  570  4                  BDGP_ParametrRequest(rangeIndex + 1,0x96,0);
  571  4            }break;
  572  3            
  573  3            case 0x96:
  574  3            {
  575  4              memcpy((uint8*)&BDGPParametrs[rangeIndex].fSensCounters,(pData + 4),4);
  576  4                  BDGP_ParametrRequest(rangeIndex + 1,0x97,0);
  577  4            }break;
  578  3            
  579  3            case 0x97:
  580  3            {
  581  4              memcpy((uint8*)&BDGPParametrs[rangeIndex].rangeMin,pData + 4,2);
  582  4              memcpy((uint8*)&BDGPParametrs[rangeIndex].rangeMax,pData + 6,2);
  583  4                //–∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ –≤—Ç–æ—Ä–æ–≥–æ —ç—Ç–∞–∂–∞ –ë–î
  584  4                if(rangeIndex == 0)
  585  4                  BDGP_ParametrRequest( 2,0x93,0);
  586  4                else
  587  4                  IMDB_BDGPGetParametrsSignalCallback();
  588  4            }break;
  589  3          }
  590  2        }
  591  1        //–∑–∞–¥–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  592  1        if(pData[0] == 0x04)
  593  1        {
  594  2          switch(pData[1])
  595  2          {
  596  3            case 0x93:
  597  3            {
  598  4                if(pData[3]<12){
  599  5                  BDGP_WriteParametr(rangeIndex + 1,0x93,pData[3] + 1,(uint8*)&BDGPParametrs[rangeIndex].fCorrectionFa
             -ctors[pData[3] + 1],sizeof(float));
  600  5                  
  601  5                }
  602  4                else
  603  4                  BDGP_WriteParametr(rangeIndex + 1,0x94,0,(uint8*)&BDGPParametrs[rangeIndex].fDeadTime,sizeof(float))
             -;
  604  4            }break;
  605  3            
  606  3            case 0x94:
  607  3            {
  608  4              BDGP_WriteParametr(rangeIndex + 1,0x95,0,(uint8*)&BDGPParametrs[rangeIndex].fEffectCounters,sizeof(flo
             -at));
  609  4            }break;
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 11  

  610  3            
  611  3            case 0x95:
  612  3            {
  613  4              BDGP_WriteParametr(rangeIndex + 1,0x96,0,(uint8*)&BDGPParametrs[rangeIndex].fSensCounters,sizeof(float
             -));
  614  4            }break;
  615  3            
  616  3            case 0x96:
  617  3            {
  618  4              rangesPack = BDGPParametrs[rangeIndex].rangeMax; 
  619  4              rangesPack = rangesPack << 16;
  620  4              rangesPack = rangesPack|BDGPParametrs[rangeIndex].rangeMin;
  621  4                
  622  4      
  623  4                BDGP_WriteParametr(rangeIndex + 1,0x97,0,(uint8*)&rangesPack,sizeof(float));
  624  4            }break;
  625  3            
  626  3            /*
  627  3              –ü–æ–ª—É—á–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è I –∏ II –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
  628  3            */
  629  3            case 0x97:
  630  3            {
  631  4              //–µ—Å–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω I - —Ç–æ –∑–∞–¥–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è II
  632  4              if(rangeIndex == 0){
  633  5                BDGP_StartWritingParametrs(1);
  634  5              }
  635  4              //–≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ, —à–ª—ë–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç
             -—Ä–æ–≤ –ø–µ—Ä–≤–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
  636  4              else{
  637  5                BDGP_WriteParametr(1,0xE0,0xFF,0,0);
  638  5              }
  639  4                
  640  4              
  641  4            }break;
  642  3            
  643  3            //–ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É –∑–∞–ø–∏—Å–∏ –≤–æ FLASH –ë–î–ì–ü-–ë I –¥–∏–∞–ø–∞–∑–æ–
             -Ω–∞
  644  3            case 0xE0:
  645  3            {
  646  4              //–µ—Å–ª–∏ I –¥–∏–∞–ø–∞–∑–æ–Ω, —Ç–æ —à–ª—ë–º –∑–∞–ø–∏—Å—å –≤–æ FLASH –¥–ª—è II –¥–∏–∞–ø–∞–∑–æ–Ω–∞
  647  4              if(rangeIndex == 0)
  648  4                BDGP_WriteParametr(2,0xE0,0xFF,0,0);
  649  4              else
  650  4                IMDB_BDGPWriteParametrsSignalCallback();  //callback —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏
  651  4            }break;
  652  3          }
  653  2        }
  654  1      
  655  1      }
  656         /*
  657         –§-–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Ñ–æ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–µ–æ –≤ —Ä–µ–∂–∏–º–µ —à—Ç–∞—Ç–Ω–æ–π —Ä–∞–±–
             -æ—Ç—ã –∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–ø–µ–∫—Ç—Ä–æ–º–µ—Ç—Ä–∞
  658         */
  659         void  BDGP_BackgroundAccumulation(uint16  *pData)
  660         {
  661  1        uint8   i = 0;
  662  1        
  663  1        float fCurrentData = 0; 
  664  1        
  665  1        if(BDGPData.BackgroundIndex < BACKGROUND_TIME){
  666  2          for(i = 0;i<SENSORS;i++){
  667  3            fCurrentData = ((pData[i] * BDGPParametrs[currentRangeIndex].fCorrectionFactors[i]) / (1.0f - pData[i] 
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 12  

             -* BDGPParametrs[currentRangeIndex].fDeadTime));
  668  3            
  669  3            BDGPData.BackgroundAverageSpeed += fCurrentData;
  670  3          }
  671  2          BDGPData.BackgroundAverageDose += BDGPData.currentDose;
  672  2          BDGPData.BackgroundIndex++;
  673  2        }
  674  1        if((BDGPData.Background == 0) && (BDGPData.BackgroundIndex == BACKGROUND_TIME) ){
  675  2          BDGPData.Background = 1;  
  676  2          BDGPData.BackgroundAverageSpeed = BDGPData.BackgroundAverageSpeed / BACKGROUND_TIME;
  677  2          BDGPData.BackgroundAverageDose = BDGPData.BackgroundAverageDose / BACKGROUND_TIME;
  678  2          
  679  2              IMDB_SendPacket(IMDB_SEND_BACKGROUND_SUCCESS,(uint8*)&BDGPData.BackgroundAverageDose,sizeof(float));//
             -–æ—Ç—Å—ã–ª–∞–µ–º —É—Å–ø–µ—Ö –≤ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–∏ —Ñ–æ–Ω–∞
  680  2              Process_SetStatus(IMDB_FULLTIME_WORK);//–ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º —à—Ç–∞—Ç–Ω–æ–π —Ä–∞–±
             -–æ—Ç—ã
  681  2        } 
  682  1      }
  683         void  BDGP_ResetBackgroundData()
  684         {
  685  1        BDGPData.BackgroundAverageSpeed = 0;
  686  1        BDGPData.BackgroundAverageDose = 0;
  687  1        
  688  1        BDGPData.BackgroundIndex = 0;
  689  1        BDGPData.Background = 0;
  690  1      }
  691         
  692         void  BDGP_InsertDataNew(uint16 regID,uint8 *pData)
  693         {
  694  1        uint8 activeBuffer = BDGPData.ActiveBuffer;
  695  1        
  696  1        if(pData[0] == 0x40 && pData[1] == 0xFF)//–ø–æ–π–º–∞–ª–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  697  1        {
  698  2          //–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–º–µ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞
  699  2          if(regID == 0x723)
  700  2            currentRangeIndex = 0;
  701  2          if(regID == 0x724)
  702  2            currentRangeIndex = 1;
  703  2          //–∫–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ú–î –∏ —Å—Ä–µ–¥–Ω–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å—á—ë—Ç–∞
  704  2          memcpy((uint8*)&BDGPData.counterRate,(uint8*)pData+2,sizeof(uint16));
  705  2          memcpy((uint8*)&BDGPData.currentDose,(uint8*)pData+4,sizeof(float));
  706  2          
  707  2          msgCounterBDGP = 0;
  708  2        }
  709  1        else
  710  1        {
  711  2          BDGPData.InputData[activeBuffer][msgCounterBDGP * 4]       = (uint16)((pData[1] << 8) | pData[0]);
  712  2          BDGPData.InputData[activeBuffer][(msgCounterBDGP * 4) + 1] = (uint16)((pData[3] << 8) | pData[2]);
  713  2          BDGPData.InputData[activeBuffer][(msgCounterBDGP * 4) + 2] = (uint16)((pData[5] << 8) | pData[4]);
  714  2          BDGPData.InputData[activeBuffer][(msgCounterBDGP * 4) + 3] = (uint16)((pData[7] << 8) | pData[6]);
  715  2          
  716  2          msgCounterBDGP++;
  717  2          /*
  718  2          //–∫–æ–ø–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å—á—ë—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–∞–∫–µ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
  719  2          memcpy((uint16*)BDGPData.sensorsCntCopy + (msgCounterBDGP * 4),(uint8*)pData,sizeof(uint16) * 4);
  720  2          
  721  2          msgCounterBDGP++;
  722  2          //–µ—Å–∏–ª –ø–æ–ª—É—á–∏–ª–∏ –≤—Å–µ –ø–∞–∫–µ—Ç—ã —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—è–º–∏, —Ç–æ –∫–æ–ø–∏—Ä—É–µ–º –∏—Ö –≤
             - —Ä–∞–±–æ—á–∏–π –º–∞—Å—Å–∏–≤
  723  2          if(msgCounterBDGP == 3){
  724  2            memcpy((uint8*)BDGPData.sensorsCnt,(uint8*)BDGPData.sensorsCntCopy,sizeof(uint16) * SENSORS);
  725  2            
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 13  

  726  2            BDGPData.CanPackageEvent = 1;
  727  2          }*/
  728  2            if(msgCounterBDGP == 3){
  729  3              if(BDGPData.ActiveBuffer == 1)
  730  3                BDGPData.ActiveBuffer = 0;
  731  3              else
  732  3                BDGPData.ActiveBuffer = 1;
  733  3              
  734  3              BDGPData.ChangeBufferEvent = 1;
  735  3            }
  736  2        }
  737  1      }
  738         
  739         void  BDGP_InsertCmd(uint8  *pData)
  740         {
  741  1        if(pData[0] == 0x42)
  742  1        {
  743  2          Process_BDGPStatus(DEVICE_READY);
  744  2          
  745  2          //–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–ª–æ–∫–∞ 1 –¥–∏–∞–ø–∞–∑–æ–Ω, –∫–æ—ç—Ñ–∏—Ü–∏–µ–Ω—Ç—ã, —Å—É–
             -±–∏–Ω–¥–µ–∫—Å - –ø–µ—Ä–≤—ã–π –∫–æ—ç—Ñ–∏—Ü–µ–Ω—Ç
  746  2          BDGP_ParametrRequest(1,0x93,0);
  747  2        }
  748  1      }
  749         float BDGP_GetAverageDoseRate()
  750         {
  751  1        return BDGPData.averageDose;
  752  1      }
  753         float   BDGP_GetCurrentDoseRate()
  754         {
  755  1        return BDGPData.currentDose;
  756  1      }
  757         
  758         uint8 *BDGP_GetParametrs()
  759         {
  760  1        return (uint8*)&BDGPParametrs;
  761  1      }
  762         
  763         float *BDGP_DirectionDiagramm(float *pData, uint8 SensCount, float cntMin,float cntMax, uint16  *pAngleMax,
             - eAngDiagrammMode Mode)
  764         {
  765  1        //float correctionData[SENSORS];
  766  1        uint16  lIndex[SENSORS];
  767  1        int16 f = 0,g = 0,b = 0;
  768  1        uint8   i = 0,j = 0;
  769  1        
  770  1        //uint16  cntMin = BDGP_MinCounter();
  771  1        //uint16  cntMax = BDGP_MaxCounter();
  772  1        float fK = 0.0f;
  773  1        float fZ = 0.0f;
  774  1        float *directionCoef;
  775  1        float SignalLevel = 0;
  776  1        float BackLevel = 0;
  777  1          
  778  1        //float *fLikelihoods = (float*)malloc(sizeof(float)*360);
  779  1        //float *fAngleDiagramm = (float*)malloc(sizeof(float)*49);
  780  1        
  781  1        float fLHMin = 100000;  //–º–∏–Ω–∏–º—É–º —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è
  782  1        float fLHMax = -100000; //–º–∞–∫—Å–∏–º—É–º —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è
  783  1        float fNLMax = -100000;//FLT_MIN; //–º–∞–∫—Å–∏–º—É–º —Å–∂–∞—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
  784  1        float fNormizeKoef = 0.0f;  //–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –Ω–æ—Ä–º–∏—Ä–æ–≤–∫–∏
  785  1        float fCountersSum = 0.0f;  //—Å—É–º–º–∞ —Å—á–µ—Ç–æ–≤ —Å—á—ë—Ç—á–∏–∫–æ–≤ –ë–î –∑–∞ –≤—Ä–µ–º—è –¥–≤–∏–∂–∫–∞
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 14  

  786  1        float fLLSum = 0;
  787  1        
  788  1        float fLog = 0; //–ø–æ–¥–ª–æ–≥–∞—Ä–∏—Ñ–º. —Ñ—É–Ω–∫—Ü–∏—è
  789  1        float fFullLog = 0;
  790  1        
  791  1        float fFirstRecalKoef = 0;
  792  1        float fSecondRecalKoef = 0;
  793  1        
  794  1        tBDSPParametrs  *curBDSPSettings;
  795  1        
  796  1        
  797  1        if(Mode == CNTR_MODE){
  798  2          fK = 0.8f - ((cntMin + 1) / (cntMax + 1));  //–∫–æ—ç—Ñ. —Ä–∞–∑—Ä—ã—Ö–ª–µ–Ω–∏—è –∂–æ–ø—ã
  799  2          directionCoef = BDGPdirectionCoef;
  800  2        }
  801  1        else{
  802  2          fK = sqrt((cntMin + 1) / (cntMax + 1));
  803  2          curBDSPSettings = (tBDSPParametrs*)BDSP_GetParametrs();
  804  2          directionCoef = BDSPdirectionCoef;
  805  2        }
  806  1        
  807  1        memset(fAngleDiagramm,0,sizeof(float) * 48);
  808  1        
  809  1        SignalLevel = (cntMax - cntMin) / (1 - directionCoef[180]);
  810  1        BackLevel = (cntMin - directionCoef[180] * cntMax) / (1 - directionCoef[180]);
  811  1        
  812  1        //–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–µ–π —Å—á—ë—Ç–∞
  813  1        if(BackLevel <= 0.0f)
  814  1          BackLevel = 0.1f;
  815  1        if(SignalLevel <= 0.0f)
  816  1          SignalLevel = 1.0f;
  817  1        
  818  1        fLog = (SignalLevel / BackLevel);
  819  1        
  820  1        //if(fLikelihoods)
  821  1        {
  822  2      
  823  2        
  824  2          for(f = 0;f<360;f++)
  825  2          {
  826  3            for(i = 0;i<SensCount;i++)
  827  3            {
  828  4              if(Mode == CNTR_MODE){        
  829  5                if( abs(-f + (30 * i)) < 181)
  830  5                {
  831  6                  lIndex[i] = abs(-f + (30 * i));
  832  6                }
  833  5                else if((360 - f + 30 * i) < 181 )
  834  5                {
  835  6                  lIndex[i] = (360 - f + 30 * i);
  836  6                }
  837  5                else
  838  5                {
  839  6                  lIndex[i] = abs(360 + f - 30 * i);
  840  6                }
  841  5              }
  842  4              else{
  843  5                if( abs(-f + (90 * i)) < 181)
  844  5                {
  845  6                  lIndex[i] = abs(-f + (90 * i));
  846  6                }
  847  5                else if((360 - f + 90 * i) < 181 )
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 15  

  848  5                {
  849  6                  lIndex[i] = (360 - f + 90 * i);
  850  6                }
  851  5                else
  852  5                {
  853  6                  lIndex[i] = abs(360 + f - 90 * i);
  854  6                }
  855  5              }
  856  4            }
  857  3            //–≤—ã—á–∏—Å–ª—è–µ–º —Ñ-–∏—é –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è
  858  3            fLikelihoods[f] = 0;
  859  3            
  860  3            for(i = 0;i<SensCount;i++)
  861  3            {
  862  4              if(Mode == CNTR_MODE)
  863  4                fLikelihoods[f] += (pData[i] * BDGPParametrs[currentRangeIndex].fCorrectionFactors[i] * log(1 + fLog 
             -* directionCoef[lIndex[i]]) - SignalLevel * directionCoef[lIndex[i]]);
  864  4              if(Mode == SPEC_MODE)
  865  4                fLikelihoods[f] += (pData[i] * curBDSPSettings->fAligmentFactors[i] * log(1 + fLog * directionCoef[lI
             -ndex[i]]) - SignalLevel * directionCoef[lIndex[i]]);
  866  4            }
  867  3          }
  868  2          //–Ω–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º—É–º 
  869  2          for(f = 0;f<360;f++)
  870  2            if(fLikelihoods[f] < fLHMin)
  871  2              fLHMin = fLikelihoods[f];
  872  2      
  873  2          //–Ω–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º—É–º
  874  2          for(f = 0;f<360;f++)
  875  2            if(fLikelihoods[f]>fLHMax)
  876  2              fLHMax = fLikelihoods[f];
  877  2          
  878  2            //–ø–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è –¥–ª—è –≥—Ä–∞–Ω–∞—Ç—ã
  879  2          if(Mode == CNTR_MODE)
  880  2          {
  881  3            //–≤—ã—á–∏—Å–ª—è–µ–º Z
  882  3            fZ = (fLHMin - (1.0f - fK) * fLHMax) / (fK * fLHMin);
  883  3            //–ø–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å —É—á–µ—Ç–æ–º fZ
  884  3            for(f = 0;f<360;f++)
  885  3              fLikelihoods[f] = fLikelihoods[f] - fZ * fLHMin;
  886  3      
  887  3            
  888  3          }
  889  2          
  890  2          //–ø–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ –¥–ª—è —Å–ø–µ–∫—Ç—Ä–æ–º–µ—Ç—Ä–∞
  891  2          if(Mode == SPEC_MODE)
  892  2          {
  893  3            fFirstRecalKoef = fLHMin - ( ((fLHMax - fLHMin) * fK) / (1 - fK));
  894  3            
  895  3            //–≤—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞–∫—Å–∏–º—É–º
  896  3            fLHMax = fLHMax - fFirstRecalKoef;//fLHMin - ( ((fLHMax - fLHMin) * fK) / (1 - fK));
  897  3            //–ø–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤—ã–≤–∞–µ–º
  898  3            for(f = 0;f<360;f++)
  899  3              //fLikelihoods[f] = (fLikelihoods[f] - fLHMin - ( ((fLHMax - fLHMin) * fK) / (1 - fK) )) / fLHMax;
  900  3                fLikelihoods[f] = (fLikelihoods[f] - fFirstRecalKoef) / fLHMax;
  901  3            
  902  3            //–Ω–∞—Ö–æ–¥–∏–º –Ω–æ–≤—ã–π –º–∏–Ω–∏–º—É–º
  903  3            fLHMin = 100000;
  904  3            for(f = 0;f<360;f++)
  905  3              if(fLikelihoods[f] < fLHMin)
  906  3                fLHMin = fLikelihoods[f];
  907  3            //–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∏–Ω–∏–º—É–º
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 16  

  908  3            fLHMin = pow(fLHMin, 1 + 8 * pow(fLHMin,8) );
  909  3              
  910  3            fSecondRecalKoef = (fK * fK - fLHMin) / (1 - fK * fK);
  911  3              
  912  3            //–≤—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞
  913  3            for(f = 0;f<360;f++){
  914  4              //fLikelihoods[f] = (pow(fLikelihoods[f],1+8*pow(fLikelihoods[f],8)) + ( (fK*fK - fLHMin)/(1 - fK*fK) 
             -) ) / (1 + ( (fK*fK - fLHMin)/(1 - fK*fK) ));
  915  4              fLikelihoods[f] = (pow(fLikelihoods[f], 1 + 8 * pow(fLikelihoods[f],8) ) + fSecondRecalKoef) / ( 1 + f
             -SecondRecalKoef);
  916  4            }
  917  3            
  918  3            
  919  3          }
  920  2            fLHMax = -100000;
  921  2            //–Ω–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º—É–º –∏ —É–≥–æ–ª
  922  2            for(f = 0;f<360;f++)
  923  2            {
  924  3              if(fLikelihoods[f]>fLHMax){
  925  4                fLHMax = fLikelihoods[f];
  926  4                *pAngleMax = f;
  927  4              }
  928  3            }     
  929  2            
  930  2            
  931  2      
  932  2          
  933  2      //    if(fAngleDiagramm)
  934  2            {
  935  3              
  936  3              
  937  3              for(f = 347;f<=359;f++)
  938  3                fAngleDiagramm[0] += fLikelihoods[f];
  939  3              for(f = 0;f<=13;f++)
  940  3                fAngleDiagramm[0] += fLikelihoods[f];
  941  3              
  942  3              
  943  3              for(f = 354;f<=359;f++)
  944  3                fAngleDiagramm[1] += fLikelihoods[f];
  945  3              for(f = 0;f<=20;f++)
  946  3                fAngleDiagramm[1] += fLikelihoods[f];
  947  3              
  948  3              g = 2;
  949  3              b = 2;
  950  3              
  951  3              do
  952  3              {
  953  4                fLLSum = 0;
  954  4                
  955  4                for(f = b;f<b + 27;f++)
  956  4                {
  957  5                  fAngleDiagramm[g] += fLikelihoods[f];
  958  5                  //fLLSum += fLikelihoods[f];
  959  5                }
  960  4                //fAngleDiagramm[g] = (1 / fLHMax) * fLLSum;
  961  4                
  962  4                if(g%2 == 0)
  963  4                  b = b + 7;  //7
  964  4                else
  965  4                  b = b + 8;  //8
  966  4                
  967  4                g++;
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 17  

  968  4              }
  969  3              while(g<47);
  970  3              
  971  3              
  972  3                fAngleDiagramm[47] = 0;
  973  3              for(f = 339;f<=359;f++)
  974  3                fAngleDiagramm[47] += fLikelihoods[f];
  975  3              for(f = 0;f<=5;f++)
  976  3                fAngleDiagramm[47] += fLikelihoods[f];      
  977  3              
  978  3              //–º–∞–∫—Å–∏–º—É–º —Å–∂–∞—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
  979  3              for(g = 0;g<48;g++)
  980  3                if(fAngleDiagramm[g] > fNLMax)
  981  3                  fNLMax = fAngleDiagramm[g];
  982  3              
  983  3              if(Mode == CNTR_MODE){
  984  4                
  985  4              for(i = SLIDER_SIZE - sliderMax;i < SLIDER_SIZE;i++)
  986  4                for(j = 0;j<SensCount;j++)
  987  4                  fCountersSum += BDGPData.sensorsCntQuery[i][j];
  988  4                
  989  4              fCountersSum = fCountersSum / SensCount;
  990  4                
  991  4              if(fCountersSum < (sliderMax * BDGPData.BackgroundAverageSpeed))
  992  4                  fNormizeKoef = 0.5f;
  993  4              else
  994  4                  fNormizeKoef = 1.0f - 0.5f * ( (sliderMax * BDGPData.BackgroundAverageSpeed) / fCountersSum );
  995  4              }
  996  3              if(Mode == SPEC_MODE)
  997  3              {
  998  4                if( ( (pData[0]+pData[1]+pData[2]+pData[3])) <= BDSP_GetBackgroundQueryIntegral())
  999  4                  fNormizeKoef = 0.5f;
 1000  4                else{
 1001  5                  fNormizeKoef = 1.0f - 0.5f * (BDSP_GetBackgroundQueryIntegral() /  (pData[0]+pData[1]+pData[2]+pData
             -[3]));
 1002  5                }
 1003  4              }
 1004  3              
 1005  3              for(g = 0;g<48;g++)
 1006  3                fAngleDiagramm[g] = fAngleDiagramm[g] * fNormizeKoef / fNLMax;
 1007  3                /*if(fNLMax == FLT_MIN)
 1008  3                  for(g = 0;g<48;g++)
 1009  3                    fAngleDiagramm[g] = 1;
 1010  3                else      
 1011  3                  for(g = 0;g<48;g++)
 1012  3                    fAngleDiagramm[g] = fAngleDiagramm[g] / fNLMax;*/
 1013  3              } 
 1014  2          
 1015  2          
 1016  2          //free(fLikelihoods);
 1017  2        }
 1018  1        return fAngleDiagramm;
 1019  1        
 1020  1      }
 1021         float *BDGP_GetAngularDiagram()
 1022         {
 1023  1        uint8 i = 0;
 1024  1        
 1025  1        float cntMin = BDGP_MinSumSensData();
 1026  1        float cntMax = BDGP_MaxSumSensData();
 1027  1        
 1028  1        float *pAngleDiagramm;  
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 18  

 1029  1      
 1030  1          pAngleDiagramm  = (float*)BDGP_DirectionDiagramm(BDGPData.fCorrectionSumSensData, SENSORS, cntMin,cntMax,
             -&BDGPData.radiationMaximum,CNTR_MODE);
 1031  1          
 1032  1      
 1033  1        //    memcpy(BDGPData.nLikelihoods,pAngleDiagramm,sizeof(float) * 48);
 1034  1        return  pAngleDiagramm;
 1035  1      
 1036  1      
 1037  1        //return BDGPData.nLikelihoods;
 1038  1      }
 1039         
 1040         void  BDGP_DataArrayCorrection(uint8  oldSize)
 1041         {
 1042  1        /*
 1043  1        1. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö–≤–æ—Å—Ç–∞ –º–∞—Å—Å–∏–≤–∞(—Ä–∞–∑–º–µ—Ä–æ–º oldSize) –≤ –Ω–∞—á–∞–ª–æ –º–∞—Å—Å–
             -∏–≤–∞
 1044  1        2. –û–±–Ω—É–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏ –º–∞—Å—Å–∏–≤–∞ —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º oldSize
 1045  1        3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ sliderCounter –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–
             -º oldSize
 1046  1        4. –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ QuerySuccess
 1047  1        */
 1048  1        memcpy(&doseArray[0],&doseArray[SLIDER_SIZE - oldSize - 1],sizeof(float) * oldSize);
 1049  1        memset(&doseArray[oldSize],0,sizeof(float) * (SLIDER_SIZE - oldSize));
 1050  1          
 1051  1        memcpy(BDGPData.sensorsCntQuery[0],BDGPData.sensorsCntQuery[SLIDER_SIZE - oldSize - 1],sizeof(float) * SE
             -NSORS * oldSize);
 1052  1        memset(BDGPData.sensorsCntQuery[oldSize],0,sizeof(float) * SENSORS * (SLIDER_SIZE - oldSize));
 1053  1        
 1054  1          sliderCounter = oldSize;
 1055  1          
 1056  1          BDGPData.QuerySuccess = 0;
 1057  1      }
 1058         void  BDGP_BackgroundIdentification()
 1059         {
 1060  1        uint8 i = 0, j = 0;
 1061  1        float fSum = 0;
 1062  1        
 1063  1      
 1064  1        
 1065  1          BDGPData.fQuantile = 0;
 1066  1        
 1067  1          for(i = 0;i<SENSORS;i++){
 1068  2            fSum += (BDGPData.fCorrectionSumSensData[i] * sliderMax);
 1069  2          }
 1070  1                //–±–µ—Ä—ë–º '—Ö–≤–æ—Å—Ç' –º–∞—Å—Å–∏–≤–∞, —Ç.–∫. —Ç–∞–º —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ú–î
             - –∏ —Å—á–µ—Ç–æ–≤
 1071  1                /*for(i = SLIDER_SIZE - sliderMax;i < SLIDER_SIZE;i++){
 1072  1                  for(j = 0;j<SENSORS;j++)
 1073  1                    fSum += BDGPData.sensorsCntQuery[i][j];
 1074  1                }*/
 1075  1      
 1076  1          
 1077  1          BDGPData.fQuantile = (fSum - (sliderMax * BDGPData.BackgroundAverageSpeed)) / (sqrt(sliderMax * BDGPData
             -.BackgroundAverageSpeed) + 1);
 1078  1        
 1079  1          if(BDGPData.fQuantile > MainSettings.limitDetect[0])
 1080  1          {
 1081  2            //—Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω—É–∫–ª–∏–¥–∞
 1082  2            if(!BDGPData.NuclideDetection){
 1083  3              BDGPData.NuclideDetection = 1;
 1084  3            
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 19  

 1085  3              IMDB_NuclideDetectionSignalCallback();
 1086  3              
 1087  3              
 1088  3            }
 1089  2          }
 1090  1          else
 1091  1          {
 1092  2            //–µ—Å–ª–∏ –±—ã–ª–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
 1093  2            if(BDGPData.NuclideDetection){
 1094  3              BDGPData.NuclideDetection = 0;
 1095  3              IMDB_NuclideEndDetectionSignalCallback(); //—à–ª—ë–º —Å–∏–≥–Ω–∞–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ
             -–Ω–∏—è –æ —Å–±—Ä–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞
 1096  3            }
 1097  2          }
 1098  1      }
 1099         
 1100         void  BDGP_Process()
 1101         {
 1102  1        uint8     i = 0,j=0;
 1103  1        
 1104  1        
 1105  1        
 1106  1        if(BDGPData.ChangeBufferEvent == 1)
 1107  1        {
 1108  2          BDGPData.ChangeBufferEvent = 0;
 1109  2          
 1110  2          if(BDGPData.ActiveBuffer == 1)
 1111  2              memcpy(BDGPData.WorkData,BDGPData.InputData[0],sizeof(uint16) * SENSORS);
 1112  2          else
 1113  2              memcpy(BDGPData.WorkData,BDGPData.InputData[1],sizeof(uint16) * SENSORS); 
 1114  2          
 1115  2              //////////////////////////////
 1116  2              //–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –¥–ª—è –ë–î–ì–ü-y–ë//
 1117  2              //////////////////////////////
 1118  2              /*
 1119  2                TO-DO —Å–¥–µ–ª–∞—Ç—å —Ä–µ–∂–∏–º –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Ñ–æ–Ω–∞!
 1120  2              */
 1121  2                //–≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Ç–µ–∫—É—â–∏–π —Ä–∞–±–æ—á–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
 1122  2              if(Process_GetOperationMode() == IMDB_BACKGROUND_ACCUMULATION){
 1123  3              //–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–ø–µ–∫—Ç—Ä–æ–º–µ—Ç—Ä–∞
 1124  3                if(Process_GetBDPSStatus() == DEVICE_NOTREADY){
 1125  4                  BDGP_BackgroundAccumulation((uint16*)BDGPData.WorkData);//–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å—á–µ—Ç–æ–≤ –ø
             -—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ —Ñ–æ–Ω–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å—á—ë—Ç–∞
 1126  4                }
 1127  3              }   
 1128  2          
 1129  2          
 1130  2          BDGPData.averageDose = 0;
 1131  2          //–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–≤–∏–∂–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –ú–î
 1132  2            if(sliderCounter<SLIDER_SIZE){
 1133  3              doseArray[sliderCounter] = BDGPData.currentDose;
 1134  3              
 1135  3              //–∑–∞–ø–æ–ª–Ω—è–µ–º –æ—á–µ—Ä–µ–¥—å —Å—á–µ—Ç–æ–≤ —Å –ø–æ–ø—Ä–∞–≤–∫–æ–π –Ω–∞ –ø–æ–ø—Ä. –∫–æ—ç—Ñ –∏ –º—ë
             -—Ä—Ç–≤–æ–µ –≤—Ä–µ–º—è
 1136  3              
 1137  3              for(i = 0;i<SENSORS;i++)
 1138  3                BDGPData.sensorsCntQuery[sliderCounter][i] = ((BDGPData.WorkData[i] * BDGPParametrs[currentRangeIndex
             -].fCorrectionFactors[i]) / (1.0f - BDGPData.WorkData[i] * BDGPParametrs[currentRangeIndex].fDeadTime));
 1139  3              
 1140  3              sliderCounter++;
 1141  3            }
 1142  2            else
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 20  

 1143  2            {
 1144  3              if(!BDGPData.QuerySuccess)  //–Ω–∞–∫–æ–ø–∏–ª–∏ –æ—á–µ—Ä–µ–¥–∏ –ú–î –∏ —Å—á–µ—Ç–æ–≤
 1145  3                BDGPData.QuerySuccess = 1;
 1146  3              
 1147  3              memcpy(&doseArray[0],&doseArray[1],sizeof(float) * (SLIDER_SIZE - 1));
 1148  3              memcpy(BDGPData.sensorsCntQuery[0],BDGPData.sensorsCntQuery[1],sizeof(float) * SENSORS * (SLIDER_SIZE 
             -- 1));
 1149  3              
 1150  3              
 1151  3              doseArray[SLIDER_SIZE - 1] = BDGPData.currentDose;
 1152  3              
 1153  3              for(i = 0;i<SENSORS;i++)
 1154  3                BDGPData.sensorsCntQuery[SLIDER_SIZE - 1][i] = ((BDGPData.WorkData[i] * BDGPParametrs[currentRangeInd
             -ex].fCorrectionFactors[i]) / (1.0f - BDGPData.WorkData[i] * BDGPParametrs[currentRangeIndex].fDeadTime));
 1155  3            }
 1156  2              
 1157  2              memset(BDGPData.fCorrectionSumSensData,0,sizeof(float) * SENSORS);  //–æ—á–∏—â–∞–µ–º —É—Å—Ä–µ–¥–Ω–µ–Ω–Ω
             -—ã–π –ø–æ –¥–≤–∏–∂–∫—É –º–∞—Å—Å–∏–≤
 1158  2            
 1159  2              if(BDGPData.QuerySuccess)
 1160  2              {
 1161  3                //–µ—Å–ª–∏ –Ω–∞–∫–æ–ø–∏–ª–∏ –¥–≤–∏–∂–æ–∫ –ú–î, —Ç–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ —
             -Å—á—ë—Ç–∞ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –ú–î
 1162  3                
 1163  3                /*
 1164  3                  TO-DO! –ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –º–∞—Å—Å–∏–≤–æ–≤ –¥–≤–∏–∂–∫–æ–≤ –≤ —Å–æ–æ—Ç
             -–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –¥–≤–∏–∂–∫–∞ –≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ
             -–Ω—É
 1165  3                */
 1166  3                if(BDGPData.counterRate < 3){
 1167  4                  /*if(sliderMax == 10)
 1168  4                    BDGP_DataArrayCorrection(sliderMax);*/
 1169  4                  
 1170  4                  sliderMax = 30;
 1171  4                }
 1172  3                else if(BDGPData.counterRate > 1 && BDGPData.counterRate < 12){
 1173  4                  /*if(sliderMax == 2)
 1174  4                    BDGP_DataArrayCorrection(sliderMax);*/
 1175  4                  
 1176  4                  sliderMax = 10;
 1177  4                }
 1178  3                else if(BDGPData.counterRate > 8)
 1179  3                  sliderMax = 2;
 1180  3                else;
 1181  3                //–±–µ—Ä—ë–º '—Ö–≤–æ—Å—Ç' –º–∞—Å—Å–∏–≤–∞, —Ç.–∫. —Ç–∞–º —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ú–î
             - –∏ —Å—á–µ—Ç–æ–≤
 1182  3                for(i = SLIDER_SIZE - sliderMax;i < SLIDER_SIZE;i++){
 1183  4                  BDGPData.averageDose += doseArray[i];
 1184  4                  for(j = 0;j<SENSORS;j++)
 1185  4                    BDGPData.fCorrectionSumSensData[j] += BDGPData.sensorsCntQuery[i][j];
 1186  4                }
 1187  3            
 1188  3                
 1189  3                BDGPData.averageDose = BDGPData.averageDose / sliderMax;
 1190  3                
 1191  3                  for(j = 0;j<SENSORS;j++)
 1192  3                    BDGPData.fCorrectionSumSensData[j] = BDGPData.fCorrectionSumSensData[j] / sliderMax;          
 1193  3              }
 1194  2              else
 1195  2              {
 1196  3                //–µ—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –≤—ã–≤–æ–¥–∏–º —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –ø–æ —Å—á—ë—Ç—á–∏–∫—É –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—
             -è
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 21  

 1197  3                for(i = 0;i<sliderCounter;i++){
 1198  4                  BDGPData.averageDose += doseArray[i];
 1199  4                  for(j = 0;j<SENSORS;j++)
 1200  4                    BDGPData.fCorrectionSumSensData[j] += BDGPData.sensorsCntQuery[i][j];
 1201  4                  
 1202  4                }
 1203  3                
 1204  3                if(sliderCounter != 0){
 1205  4                  BDGPData.averageDose = BDGPData.averageDose / sliderCounter;
 1206  4                  
 1207  4                  for(j = 0;j<SENSORS;j++)
 1208  4                    BDGPData.fCorrectionSumSensData[j] = BDGPData.fCorrectionSumSensData[j] / sliderCounter;
 1209  4                }
 1210  3              }
 1211  2              BDGPData.Dose += (BDGPData.currentDose * DOSE_TO_HOUR);
 1212  2              //BDGPData.Dose= BDGPData.Dose * DOSE_TO_HOUR;
 1213  2              //—Ñ–æ–Ω–æ–≤–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
 1214  2              if(Process_GetBDPSStatus() == DEVICE_NOTREADY){
 1215  3                if(BDGPData.Background){
 1216  4                  BDGP_BackgroundIdentification();
 1217  4                }
 1218  3              }
 1219  2                    
 1220  2        }
 1221  1      }
 1222         
 1223         //float BDGP_GetMaximumAngle()
 1224         uint16  BDGP_GetMaximumAngle()
 1225         {
 1226  1        //float fAngle = (float)BDGPData.radiationMaximum;
 1227  1        //return fAngle;
 1228  1        return BDGPData.radiationMaximum;
 1229  1      }
 1230         float BDGP_GetDose()
 1231         {
 1232  1        return BDGPData.Dose;
 1233  1      }
 1234         uint8   BDGP_GetBackgroundState()
 1235         {
 1236  1        return BDGPData.Background;
 1237  1      }
 1238         
 1239         uint8 BDGP_GetOutsideFeature()
 1240         { 
 1241  1          if(BDGPData.currentDose >= 1.3f * BDGPData.averageDose)
 1242  1            return 1; //–ú–î —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å
 1243  1          else if(BDGPData.currentDose <= 0.7f * BDGPData.averageDose)
 1244  1            return 2; //–ú–î —É–º–µ–Ω—å—à–∏–ª–∞—Å—å
 1245  1          else
 1246  1            return 0; //–ú–î –Ω–µ–∏–∑–º–µ–Ω–∏–ª–∞—Å—å
 1247  1      }
 1248         


MODULE INFORMATION:   INITIALIZED  UNINITIALIZED
  CODE SIZE        =       10188     --------
  NEAR-CONST SIZE  =           7     --------
  FAR-CONST SIZE   =    --------     --------
  HUGE-CONST SIZE  =    --------     --------
  XHUGE-CONST SIZE =        1448     --------
  NEAR-DATA SIZE   =           5     --------
  FAR-DATA SIZE    =    --------     --------
C166 COMPILER V7.53.0.0, BDGP                                                              12/14/2017 11:31:12 PAGE 22  

  XHUGE-DATA SIZE  =        3668     --------
  IDATA-DATA SIZE  =    --------     --------
  SDATA-DATA SIZE  =    --------     --------
  BDATA-DATA SIZE  =    --------     --------
  HUGE-DATA SIZE   =    --------     --------
  BIT SIZE         =    --------     --------
  INIT'L SIZE      =          30     --------
END OF MODULE INFORMATION.


C166 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
